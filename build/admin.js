(()=>{"use strict";function t(t){const e={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"};return t.replace(/[&<>"']/g,function(t){return e[t]})}function e(e,n=!0){const i=document.createElement("div");i.className=`notice notice-${n?"success":"error"} is-dismissible`,i.innerHTML=`\n\t\t<p>${t(e)}</p>\n\t\t<button type="button" class="notice-dismiss">\n\t\t\t<span class="screen-reader-text">Dismiss this notice.</span>\n\t\t</button>\n\t`;const s=document.querySelector(".wrap");s&&s.insertBefore(i,s.firstChild),setTimeout(()=>{i.parentNode&&i.remove()},5e3);const a=i.querySelector(".notice-dismiss");a&&a.addEventListener("click",()=>{i.remove()})}function n(t){return document.getElementById(t)}function i(t,e,n){t&&t.addEventListener(e,n)}function s(t,e={}){return new Promise((n,i)=>{const s=new FormData;s.append("action",t),s.append("nonce",window.linkReplacement.nonce),Object.keys(e).forEach(t=>{s.append(t,e[t])}),fetch(window.linkReplacement.ajaxUrl,{method:"POST",body:s}).then(t=>t.json()).then(t=>{t.success?n(t.data):i(new Error(t.data||"Unknown error"))}).catch(t=>{i(t)})})}function a(t,e,n="Loading..."){t&&(e?(t.dataset.originalText=t.textContent,t.textContent=n,t.disabled=!0,t.classList.add("loading")):(t.textContent=t.dataset.originalText||t.textContent,t.disabled=!1,t.classList.remove("loading")))}const o=class{constructor(){this.importPreviewData=null,this.init()}init(){this.bindEvents()}bindEvents(){const t=n("preview-import"),e=n("import-urls");t&&i(t,"click",this.handlePreviewImport.bind(this)),e&&i(e,"click",this.handleImport.bind(this)),document.addEventListener("click",this.handleDynamicEvents.bind(this))}handleDynamicEvents(t){const e=t.target;if(e.classList.contains("edit-replacement-btn")){const t=parseInt(e.dataset.index);this.editReplacement(t)}if(e.classList.contains("preview-locations-btn")){const t=parseInt(e.dataset.index);this.toggleLocationPreview(t,e)}}async handlePreviewImport(t){const i=n("import-file"),s=i?.files[0];if(s)try{const e=await this.readFile(s),n=s.name.toLowerCase().endsWith(".json")?"json":"csv";await this.previewImport(e,n,t.target)}catch(t){e("Error reading file: "+t.message,!1)}else e("Please select a file to preview.",!1)}async handleImport(t){const i=n("import-file"),s=i?.files[0];if(s)try{const e=await this.readFile(s),n=s.name.toLowerCase().endsWith(".json")?"json":"csv";await this.importReplacements(e,n,t.target)}catch(t){e("Error reading file: "+t.message,!1)}else e("Please select a file to import.",!1)}readFile(t){return new Promise((e,n)=>{const i=new FileReader;i.onload=t=>e(t.target.result),i.onerror=t=>n(new Error("Failed to read file")),i.readAsText(t)})}async previewImport(t,e,n){a(n,!0,"Previewing...");try{const n=await s("content_studio_preview_import",{file_content:t,file_type:e});this.showImportPreview(n)}catch(t){this.showImportResult(t.message,!1)}finally{a(n,!1)}}async importReplacements(t,e,n){a(n,!0,"Importing...");try{const n=await s("content_studio_import_urls",{file_content:t,file_type:e});this.showImportResult(n.message,!0),setTimeout(()=>{window.location.reload()},2e3)}catch(t){this.showImportResult(t.message,!1)}finally{a(n,!1)}}showImportPreview(e){const i=n("import-preview"),s=n("import-urls");if(!i)return;if(0===e.count){let t="<h4>No URLs with instances found</h4>";return t+="<p>None of the URLs in your import file were found on this site.</p>",e.total_imported&&e.total_imported>0&&(t+=`<p><strong>Total URLs in file:</strong> ${e.total_imported}</p>`,t+=`<p><strong>URLs with zero instances:</strong> ${e.filtered_out}</p>`),t+="<p>You may want to check your URLs or try importing a different file.</p>",i.innerHTML=t,i.style.display="block",void(s&&(s.style.display="none"))}let a=`<h4>Preview: ${e.count} replacements found`;e.total_imported&&e.total_imported>e.count&&(a+=` (filtered from ${e.total_imported} total URLs)`),a+="</h4>",e.filtered_out&&e.filtered_out>0&&(a+='<div class="inline notice notice-info"><p>',a+=`<strong>Note:</strong> ${e.filtered_out} URLs were filtered out because they have zero instances on this site. `,a+="Only URLs that actually exist on your site are shown below.",a+="</p></div>"),a+='<div class="preview-table">',a+='<table class="fixed wp-list-table widefat striped">',a+="<thead><tr><th>Old URL</th><th>New URL</th><th>Actions</th></tr></thead>",a+="<tbody>",e.replacements.forEach((e,n)=>{a+=`<tr class="replacement-row" data-index="${n}">`,a+=`<td><a href="${t(e.from_url)}" target="_blank">${t(e.from_url)}</a></td>`,a+=`<td><a href="${t(e.to_url)}" target="_blank">${t(e.to_url)}</a></td>`,a+='<td class="actions-cell">',a+='<div class="action-buttons">',a+=`<button type="button" class="button button-small button-secondary preview-locations-btn" data-index="${n}">Preview Locations</button>`,a+=`<button type="button" class="button button-small button-secondary edit-replacement-btn" data-index="${n}">Replace Single</button>`,a+="</div>",a+="</td>",a+="</tr>",a+=`<tr class="preview-row" data-index="${n}" style="display: none;">`,a+='<td colspan="3" class="preview-content">',a+='<div class="preview-loading">Loading preview...</div>',a+="</td>",a+="</tr>"}),a+="</tbody></table></div>",a+='<p><strong>Review the replacements above. Click "Replace Single" to load each replacement into the form above for individual processing.</strong></p>',i.innerHTML=a,i.style.display="block",s&&(s.style.display="none"),this.importPreviewData=e}showImportResult(e,i){const s=n("import-result");s&&(s.className=i?"success":"error",s.innerHTML=`<p>${t(e)}</p>`,s.style.display="block",i&&setTimeout(()=>{s.style.display="none"},5e3))}refreshImportPreview(){if(!this.importPreviewData)return;const t=n("single-from-url")?.value,e=n("single-to-url")?.value;t&&e&&(this.importPreviewData.replacements=this.importPreviewData.replacements.filter(n=>!(n.from_url===t&&n.to_url===e)),this.importPreviewData.count=this.importPreviewData.replacements.length,this.showImportPreview(this.importPreviewData))}async toggleLocationPreview(t,e){const n=document.querySelector(`.preview-row[data-index="${t}"]`);n&&("none"===n.style.display?(n.style.display="table-row",e.textContent="Hide Preview",await this.loadLocationPreview(t)):(n.style.display="none",e.textContent="Preview Locations"))}async loadLocationPreview(e){if(!this.importPreviewData||!this.importPreviewData.replacements[e])return;const n=this.importPreviewData.replacements[e],i=document.querySelector(`.preview-row[data-index="${e}"] .preview-content`);if(i){i.innerHTML='<div class="preview-loading">Searching for instances...</div>';try{const t=await s("content_studio_find_instances",{search_url:n.from_url});this.displayLocationPreview(t,i)}catch(e){i.innerHTML=`<div class="preview-error">Error: ${t(e.message)}</div>`}}}displayLocationPreview(e,n){let i='<div class="location-preview">';i+=`<h5>Found ${e.total_found} instances in ${e.locations.length} locations:</h5>`,e.locations.length>0?(i+='<div class="location-list">',e.locations.forEach(e=>{i+='<div class="location-item">',i+='<div class="location-header">',i+=`<strong>${t(e.title)}</strong>`,i+=`<span class="location-type">(${t(e.type)})</span>`,i+=`<span class="location-count">${e.count} instance(s)</span>`,i+="</div>",i+='<div class="location-actions">',i+=`<a href="${t(e.url)}" target="_blank" class="button button-small">View</a>`,e.edit_url&&(i+=`<a href="${t(e.edit_url)}" target="_blank" class="button button-small">Edit</a>`),i+="</div>",i+="</div>"}),i+="</div>"):i+="<p>No instances found.</p>",i+="</div>",n.innerHTML=i}editReplacement(t){if(!this.importPreviewData||!this.importPreviewData.replacements[t])return;const e=this.importPreviewData.replacements[t],i=n("single-from-url"),s=n("single-to-url");i&&(i.value=e.from_url),s&&(s.value=e.to_url);const a=document.querySelector(".content-studio-single-replacement");a&&a.scrollIntoView({behavior:"smooth",block:"start"});const o=n("single-results");o&&(o.innerHTML='<div class="single-results-summary info"><h4>ℹ Info</h4><p>Replacement loaded into Single URL Replacement form above.</p></div>',o.style.display="block")}},l=class{constructor(){this.searchResultsData=null,this.init()}init(){this.bindEvents()}bindEvents(){const t=n("find-instances"),e=n("replace-instances");t&&i(t,"click",this.handleFindInstances.bind(this)),e&&i(e,"click",this.handleReplaceInstances.bind(this)),document.addEventListener("click",this.handlePagination.bind(this))}handlePagination(t){const e=t.target;if(!e.classList.contains("pagination-btn"))return;const n=parseInt(e.dataset.page);!this.searchResultsData||n<1||(this.searchResultsData.currentPage=n,this.updateResultsTable())}async handleFindInstances(t){const i=n("single-from-url")?.value;i?await this.findUrlInstances(i,t.target):e("Please enter a URL to search for.",!1)}async handleReplaceInstances(t){const i=n("single-from-url")?.value,s=n("single-to-url")?.value;i&&s?confirm("Are you sure you want to replace all instances? This action cannot be undone.")&&await this.replaceUrlInstances(i,s,t.target):e("Please enter both URLs.",!1)}async findUrlInstances(t,e){a(e,!0,"Searching...");try{const e=await s("content_studio_find_instances",{search_url:t});this.showFindResults(e,t)}catch(t){this.showSingleResults("error",t.message)}finally{a(e,!1)}}async replaceUrlInstances(t,e,i){a(i,!0,"Replacing...");try{const i=await s("content_studio_replace_instances",{from_url:t,to_url:e});this.showReplaceResults(i,t,e),window.importManager&&window.importManager.importPreviewData&&"none"!==n("import-preview")?.style.display&&window.importManager.refreshImportPreview()}catch(t){this.showSingleResults("error",t.message)}finally{a(i,!1)}}showFindResults(e,i){let s=`Found ${e.total_found} instances of "${t(i)}" in ${e.locations.length} locations.`,a="";if(e.total_found>0){s+=' Click "Replace All Instances" to replace them.';const t=n("replace-instances");t&&(t.style.display="block"),this.searchResultsData={locations:e.locations,searchUrl:i,currentPage:1,itemsPerPage:25},a=this.buildPaginatedResultsTable()}else{s+=" No replacement needed.";const t=n("replace-instances");t&&(t.style.display="none")}this.showSingleResults("info",s,e,a)}buildPaginatedResultsTable(){if(!this.searchResultsData)return"";const{locations:e,currentPage:n,itemsPerPage:i}=this.searchResultsData,s=Math.ceil(e.length/i),a=(n-1)*i,o=Math.min(a+i,e.length),l=e.slice(a,o);let r='<div class="search-results-table">';if(r+="<h4>Locations where this URL appears:</h4>",r+='<div class="pagination-info">',r+=`Showing ${a+1} to ${o} of ${e.length} locations`,r+="</div>",r+='<div class="results-table">',r+='<table class="fixed wp-list-table widefat striped">',r+="<thead><tr><th>Title</th><th>Type</th><th>Count</th><th>Actions</th></tr></thead>",r+="<tbody>",l.forEach(e=>{r+="<tr>",r+=`<td><strong>${t(e.title)}</strong></td>`,r+=`<td>${t(e.type)}</td>`,r+=`<td>${e.count}</td>`,r+='<td class="actions-cell">',r+='<div class="action-buttons">',r+=`<a href="${t(e.url)}" target="_blank" class="button button-small">View</a>`,e.edit_url&&(r+=`<a href="${t(e.edit_url)}" target="_blank" class="button button-small">Edit</a>`),r+="</div>",r+="</td>",r+="</tr>"}),r+="</tbody></table></div>",s>1){r+='<div class="pagination-controls">',n>1&&(r+=`<button type="button" class="button button-secondary pagination-btn" data-page="${n-1}">← Previous</button>`);const t=Math.max(1,n-2),e=Math.min(s,n+2);t>1&&(r+='<button type="button" class="button button-secondary pagination-btn" data-page="1">1</button>',t>2&&(r+='<span class="pagination-ellipsis">...</span>'));for(let i=t;i<=e;i++)r+=`<button type="button" class="button${i===n?" button-primary":" button-secondary"} pagination-btn" data-page="${i}">${i}</button>`;e<s&&(e<s-1&&(r+='<span class="pagination-ellipsis">...</span>'),r+=`<button type="button" class="button button-secondary pagination-btn" data-page="${s}">${s}</button>`),n<s&&(r+=`<button type="button" class="button button-secondary pagination-btn" data-page="${n+1}">Next →</button>`),r+="</div>"}return r+="</div>",r}updateResultsTable(){const t=n("single-results");if(!t||!this.searchResultsData)return;const e=t.innerHTML,i=this.buildPaginatedResultsTable(),s=e.replace(/<div class="search-results-table">[\s\S]*<\/div>/,i);t.innerHTML=s}showReplaceResults(e,i,s){const a=`Successfully replaced "${t(i)}" with "${t(s)}".`;let o='<div class="single-results-details">';o+='<div class="single-results-stat">',o+=`<span class="number">${e.replaced_posts}</span>`,o+='<span class="label">Posts & Pages</span>',o+="</div>",o+='<div class="single-results-stat">',o+=`<span class="number">${e.replaced_meta}</span>`,o+='<span class="label">Post Meta (ACF)</span>',o+="</div>",o+="</div>",this.showSingleResults("success",a,null,o);const l=n("replace-instances");l&&(l.style.display="none")}showSingleResults(t,e,i,s){const a=n("single-results");if(!a)return;let o=`<div class="single-results-summary ${t}">`;o+=`<h4>${"success"===t?"✓":"error"===t?"✗":"ℹ"} ${"success"===t?"Success":"error"===t?"Error":"Info"}</h4>`,o+=`<p>${e}</p>`,s&&(o+=s),o+="</div>",a.innerHTML=o,a.style.display="block"}},r=class{constructor(){this.init()}init(){}async loadLocationPreview(e,n){if(n){n.innerHTML='<div class="preview-loading">Searching for instances...</div>';try{const t=await s("content_studio_find_instances",{search_url:e});this.displayLocationPreview(t,n)}catch(e){n.innerHTML=`<div class="preview-error">Error: ${t(e.message)}</div>`}}}displayLocationPreview(e,n){let i='<div class="location-preview">';i+=`<h5>Found ${e.total_found} instances in ${e.locations.length} locations:</h5>`,e.locations.length>0?(i+='<div class="location-list">',e.locations.forEach(e=>{i+='<div class="location-item">',i+='<div class="location-header">',i+=`<strong>${t(e.title)}</strong>`,i+=`<span class="location-type">(${t(e.type)})</span>`,i+=`<span class="location-count">${e.count} instance(s)</span>`,i+="</div>",i+='<div class="location-actions">',i+=`<a href="${t(e.url)}" target="_blank" class="button button-small">View</a>`,e.edit_url&&(i+=`<a href="${t(e.edit_url)}" target="_blank" class="button button-small">Edit</a>`),i+="</div>",i+="</div>"}),i+="</div>"):i+="<p>No instances found.</p>",i+="</div>",n.innerHTML=i}createLocationPreviewWidget(e,n={}){const i=document.createElement("div");i.className="location-preview-widget";const s=document.createElement("div");s.className="location-preview-header",s.innerHTML=`<h4>Location Preview: ${t(e)}</h4>`;const a=document.createElement("div");return a.className="location-preview-content",a.innerHTML='<div class="preview-loading">Loading...</div>',i.appendChild(s),i.appendChild(a),this.loadLocationPreview(e,a),i}toggleLocationPreview(t,e){t&&e&&("none"!==t.style.display?(t.style.display="none",e.textContent="Show Preview"):(t.style.display="block",e.textContent="Hide Preview"))}createCollapsibleLocationPreview(t,e={}){const n=document.createElement("div");n.className="collapsible-location-preview";const i=document.createElement("button");i.type="button",i.className="button button-secondary location-preview-toggle",i.textContent="Show Location Preview";const s=document.createElement("div");return s.className="location-preview-content",s.style.display="none",i.addEventListener("click",()=>{this.toggleLocationPreview(s,i),"none"===s.style.display||s.dataset.loaded||(this.loadLocationPreview(t,s),s.dataset.loaded="true")}),n.appendChild(i),n.appendChild(s),n}};const c=new class{constructor(){this.importManager=null,this.singleReplacementManager=null,this.locationPreviewManager=null,this.init()}init(){"loading"===document.readyState?document.addEventListener("DOMContentLoaded",()=>this.initializeModules()):this.initializeModules()}initializeModules(){try{this.importManager=new o,this.singleReplacementManager=new l,this.locationPreviewManager=new r,window.importManager=this.importManager,window.singleReplacementManager=this.singleReplacementManager,window.locationPreviewManager=this.locationPreviewManager,this.initializeAdditionalFeatures(),console.log("Content Studio Admin initialized successfully")}catch(t){console.error("Error initializing Content Studio Admin:",t),e("Error initializing admin interface: "+t.message,!1)}}initializeAdditionalFeatures(){this.setupKeyboardShortcuts(),this.setupFormValidation(),this.setupAccessibilityFeatures()}setupKeyboardShortcuts(){document.addEventListener("keydown",t=>{if((t.ctrlKey||t.metaKey)&&"Enter"===t.key){const e=document.getElementById("find-instances");e&&null!==e.offsetParent&&(t.preventDefault(),e.click())}if("Escape"===t.key){const t=document.getElementById("single-results");t&&"none"!==t.style.display&&(t.style.display="none")}})}setupFormValidation(){const t=document.getElementById("single-from-url"),e=document.getElementById("single-to-url");t&&t.addEventListener("input",this.validateUrlInput.bind(this)),e&&e.addEventListener("input",this.validateUrlInput.bind(this))}validateUrlInput(t){const e=t.target,n=e.value.trim();if(e.classList.remove("valid","invalid"),""!==n)try{new URL(n),e.classList.add("valid")}catch{e.classList.add("invalid")}}setupAccessibilityFeatures(){const t=document.getElementById("find-instances"),e=document.getElementById("replace-instances");t&&t.setAttribute("aria-label","Find all instances of the URL in the first field"),e&&e.setAttribute("aria-label","Replace all instances of the URL with the new URL");const n=document.createElement("div");n.setAttribute("aria-live","polite"),n.setAttribute("aria-atomic","true"),n.className="sr-only",n.id="content-studio-live-region",document.body.appendChild(n)}announceToScreenReader(t){const e=document.getElementById("content-studio-live-region");e&&(e.textContent=t,setTimeout(()=>{e.textContent=""},1e3))}getModule(t){switch(t){case"import":return this.importManager;case"singleReplacement":return this.singleReplacementManager;case"locationPreview":return this.locationPreviewManager;default:return null}}destroy(){this.importManager,this.singleReplacementManager,this.locationPreviewManager,delete window.importManager,delete window.singleReplacementManager,delete window.locationPreviewManager}};window.contentStudioAdmin=c})();